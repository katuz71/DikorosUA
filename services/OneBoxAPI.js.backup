// services/OneBoxAPI.js
const ONEBOX_CONFIG = {
  baseURL: 'https://dikoros.1b.app',  // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
  login: 'roma.ozivskij@gmail.com',                       // –ª–æ–≥–∏–Ω –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ API-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  apiPassword: '8cda78e626e22a2a3600a3302e31333134323530302031373639353338373833'   // REST API –ø–∞—Ä–æ–ª—å –∏–∑ OneBox
};

let authToken = null;
let tokenExpiry = 0;

class OneBoxAPI {
  // –ü–æ–ª—É—á–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (OneBox API v2)
  async getAuthToken() {
    if (authToken && Date.now() < tokenExpiry) {
      console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω OneBox');
      return authToken;
    }

    // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è OneBox API v2
    const url = `${ONEBOX_CONFIG.baseURL}/api/v2/token/get/`;
    
    console.log('üîë OneBox API v2 Token Request URL:', url);
    console.log('üîë OneBox Auth Params:', { login: ONEBOX_CONFIG.login, password: '***' });

    try {
      // –ü—Ä–æ–±—É–µ–º JSON —Ñ–æ—Ä–º–∞—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, OneBox –æ–∂–∏–¥–∞–µ—Ç JSON)
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          login: ONEBOX_CONFIG.login,
          password: ONEBOX_CONFIG.apiPassword
        })
      });
      
      const responseText = await response.text();
      
      console.log('üì• OneBox Token Response Status:', response.status);
      console.log('üì• OneBox Token Response:', responseText);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç JSON
      if (!responseText.trim().startsWith('{') && !responseText.trim().startsWith('[')) {
        throw new Error(`OneBox –≤–µ—Ä–Ω—É–ª –Ω–µ JSON. –°—Ç–∞—Ç—É—Å: ${response.status}. Response: ${responseText.substring(0, 150)}`);
      }
      
      const data = JSON.parse(responseText);
      
      // OneBox API v2 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –≤ –ø–æ–ª–µ 'token'
      if (data.token) {
        authToken = data.token;
        tokenExpiry = Date.now() + 55 * 60 * 1000; // 55 –º–∏–Ω—É—Ç
        console.log('‚úÖ OneBox —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ (API v2)');
        return authToken;
      }
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞, –≤—ã–≤–æ–¥–∏–º –¥–µ—Ç–∞–ª–∏
      if (data.errorArray || data.error) {
        const errorMsg = data.errorArray ? data.errorArray.join(', ') : data.error;
        throw new Error(`OneBox API error: ${errorMsg}`);
      }
      
      throw new Error(data.message || 'Token not received');
    } catch (error) {
      console.error('‚ùå OneBox auth error:', error);
      throw error;
    }
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  async createOrder(orderData) {
    const token = await this.getAuthToken();
    
    console.log('üì¶ OneBox createOrder - –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', JSON.stringify(orderData, null, 2));
    
    const params = new URLSearchParams({
      userauthtoken: token,
      ordercode: orderData.externalId || Date.now().toString(),
      workflowname: '–ó–∞–∫–∞–∑—ã',  // –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
      statusname: '–ù–æ–≤—ã–π',
      clientphone: orderData.phone,
      clientemail: orderData.email || '',
      clientnamefirst: orderData.firstName || '',
      clientnamelast: orderData.lastName || '',
      sum: orderData.totalAmount,
      payed: orderData.isPaid ? 1 : 0
    });

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã
    orderData.items?.forEach((item, index) => {
      params.append(`productArray[${index}][name]`, item.name);
      params.append(`productArray[${index}][price]`, item.price);
      params.append(`productArray[${index}][count]`, item.quantity);
    });

    const url = `${ONEBOX_CONFIG.baseURL}/api/orders/add/?${params}`;
    console.log('üì¶ OneBox Order Request URL:', url.substring(0, 200) + '...');
    
    try {
      const response = await fetch(url, { method: 'POST' });
      const responseText = await response.text();
      
      console.log('üì• OneBox Order Response Status:', response.status);
      console.log('üì• OneBox Order Response (first 300 chars):', responseText.substring(0, 300));
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç JSON
      if (!responseText.trim().startsWith('{') && !responseText.trim().startsWith('[')) {
        throw new Error(`OneBox –≤–µ—Ä–Ω—É–ª –Ω–µ JSON. –°—Ç–∞—Ç—É—Å: ${response.status}. Response: ${responseText.substring(0, 150)}`);
      }
      
      const result = JSON.parse(responseText);
      
      if (result.status === 'ok') {
        console.log('‚úÖ OneBox –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ, ID:', result.orderid);
        return { success: true, orderId: result.orderid };
      }
      throw new Error(result.message || 'Order creation failed');
    } catch (error) {
      console.error('‚ùå OneBox order creation error:', error);
      throw error;
    }
  }
}

export default new OneBoxAPI();

# -*- coding: utf-8 -*-
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è AI —á–∞—Ç—É –≤ main.py
–ü–æ–∫—Ä–∞—â—É—î —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç —Ç–∞ –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ—à—É–∫—É —Ç–æ–≤–∞—Ä—ñ–≤
"""

import re

# –ß–∏—Ç–∞—î–º–æ —Ñ–∞–π–ª
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω—É —Å–µ–∫—Ü—ñ—é —á–∞—Ç—É
# –í–∏–¥–∞–ª—è—î–º–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ–¥

# –®—É–∫–∞—î–º–æ –ø–æ—á–∞—Ç–æ–∫ —Ñ—É–Ω–∫—Ü—ñ—ó chat_endpoint
chat_start = content.find('@app.post("/chat")')
if chat_start == -1:
    print("‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ñ—É–Ω–∫—Ü—ñ—é /chat")
    exit(1)

# –®—É–∫–∞—î–º–æ –∫—ñ–Ω–µ—Ü—å —Ñ—É–Ω–∫—Ü—ñ—ó (–Ω–∞—Å—Ç—É–ø–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∞–±–æ –∫—ñ–Ω–µ—Ü—å —Ñ–∞–π–ª—É)
next_function = content.find('@app.post("/upload")', chat_start)
if next_function == -1:
    next_function = content.find('# 6. –£–¢–ò–õ–ò–¢–´', chat_start)

if next_function == -1:
    print("‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫—ñ–Ω–µ—Ü—å —Ñ—É–Ω–∫—Ü—ñ—ó")
    exit(1)

# –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—É —Ñ—É–Ω–∫—Ü—ñ—é
before_chat = content[:chat_start]
after_chat = content[next_function:]

# –ù–æ–≤–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —á–∞—Ç—É
new_chat_function = '''@app.post("/chat")
async def chat_endpoint(request: ChatRequest):
    """–£–º–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç —á–∞—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π GPT –∏ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤"""
    try:
        user_message = request.messages[-1].content
        user_message_lower = user_message.lower()
        
        # 1. –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ (–£–ª—É—á—à–µ–Ω–Ω—ã–π: Python-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –∏ –ø–æ–∏—Å–∫–∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏)
        conn = get_db_connection()
        conn.row_factory = sqlite3.Row
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞
        all_products_rows = conn.execute("SELECT * FROM products").fetchall()
        all_products = [dict(r) for r in all_products_rows]
        conn.close()

        # –û—á–∏—Å—Ç–∫–∞ –∏ —Ä–∞–∑–±–∏–≤–∫–∞ –Ω–∞ —Å–ª–æ–≤–∞
        import re
        clean_message = re.sub(r'[^\\w\\s]', ' ', user_message_lower)
        words = [w for w in clean_message.split() if len(w) > 1] 
        found_products = []
        
        if words:
            # –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∫–æ—Ä–∏–Ω–≥ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            scored_products = []
            for p in all_products:
                score = 0
                p_name_lower = (p['name'] or "").lower()
                p_desc_lower = (p['description'] or "").lower()
                p_comp_lower = (p.get('composition', '') or "").lower()
                p_usage_lower = (p.get('usage', '') or "").lower()
                
                for word in words:
                    # –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ (5 –±–∞–ª–ª–æ–≤)
                    if word in p_name_lower:
                        score += 5
                    # –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ (3 –±–∞–ª–ª–∞)
                    if word in p_desc_lower:
                        score += 3
                    # –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ —Å–æ—Å—Ç–∞–≤–µ (2 –±–∞–ª–ª–∞)
                    if word in p_comp_lower:
                        score += 2
                    # –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ (2 –±–∞–ª–ª–∞)
                    if word in p_usage_lower:
                        score += 2
                
                if score > 0:
                    scored_products.append((score, p))
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –±–µ—Ä–µ–º —Ç–æ–ø-8
            scored_products.sort(key=lambda x: x[0], reverse=True)
            found_products = [item[1] for item in scored_products[:8]]
        
        # 2. GPT –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
        if openai_client:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –±–æ—Ç–∞
            products_context = ""
            if found_products:
                products_list = []
                for p in found_products:
                    product_info = f"""
üì¶ {p['name']}
üí∞ –¶—ñ–Ω–∞: {p['price']} –≥—Ä–Ω
üìù –û–ø–∏—Å: {p.get('description', '')[:200]}...
üåø –°–∫–ª–∞–¥: {p.get('composition', '')[:100]}...
üíä –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è: {p.get('usage', '')[:150]}...
---"""
                    products_list.append(product_info)
                
                products_context = "–î–û–°–¢–£–ü–ù–Ü –¢–û–í–ê–†–ò (—Ä–µ–∫–æ–º–µ–Ω–¥—É–π —ó—Ö –∫–ª—ñ—î–Ω—Ç—É!):\\n" + "\\n".join(products_list)
            else:
                products_context = "–¢–æ–≤–∞—Ä—ñ–≤ –∑–∞ —Ü–∏–º –∑–∞–ø–∏—Ç–æ–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ó–∞–ø—Ä–æ–ø–æ–Ω—É–π –∫–ª—ñ—î–Ω—Ç—É —ñ–Ω—à—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: –ª—ñ–∫–∞—Ä—Å—å–∫—ñ –≥—Ä–∏–±–∏ (–ß–∞–≥–∞, –†–µ–π—à—ñ, –á–∂–æ–≤–∏–∫), —Ç—Ä–∞–≤–∏, CBD –æ–ª—ñ—è, –º—ñ–∫—Ä–æ–¥–æ–∑–∏–Ω–≥."

            # –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            system_prompt = f"""
            –¢–∏ ‚Äî –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç-–µ–∫—Å–ø–µ—Ä—Ç –º–∞–≥–∞–∑–∏–Ω—É DikorosUA (–ª—ñ–∫–∞—Ä—Å—å–∫—ñ –≥—Ä–∏–±–∏, —Ç—Ä–∞–≤–∏, –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ñ –¥–æ–±–∞–≤–∫–∏).
            –¢–≤–æ—è –º–µ—Ç–∞ ‚Äî –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É –∑–Ω–∞–π—Ç–∏ —ñ–¥–µ–∞–ª—å–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç —Ç–∞ –ü–†–û–î–ê–¢–ò –π–æ–≥–æ, —Ä–æ–∑–ø–æ–≤—ñ–≤—à–∏ –ø—Ä–æ –ø–µ—Ä–µ–≤–∞–≥–∏.
            
            –ó–ù–ê–ô–î–ï–ù–Ü –¢–û–í–ê–†–ò –ó–ê –ó–ê–ü–ò–¢–û–ú:
            {products_context}
            
            –ü–†–ê–í–ò–õ–ê –°–ü–Ü–õ–ö–£–í–ê–ù–ù–Ø:
            1. üéØ –ó–ê–í–ñ–î–ò —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ç–æ–≤–∞—Ä–∏ –∑—ñ —Å–ø–∏—Å–∫—É –≤–∏—â–µ - –Ω–∞–∑–∏–≤–∞–π —ó—Ö –ø–æ —ñ–º–µ–Ω—ñ —Ç–∞ —Ü—ñ–Ω—ñ
            2. üí™ –†–æ–∑–∫–∞–∂–∏ –ø—Ä–æ –ö–û–†–ò–°–¢–¨ —Ç–∞ –ü–ï–†–ï–í–ê–ì–ò —Ç–æ–≤–∞—Ä—É (–¥–ª—è —á–æ–≥–æ, —è–∫ –¥–æ–ø–æ–º–∞–≥–∞—î)
            3. ‚ú® –ü—ñ–¥–∫—Ä–µ—Å–ª–∏ –£–ù–Ü–ö–ê–õ–¨–ù–Ü–°–¢–¨ - –µ–∫–æ–ª–æ–≥—ñ—á–Ω—ñ—Å—Ç—å, —è–∫—ñ—Å—Ç—å, –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –∑ –ö–∞—Ä–ø–∞—Ç
            4. üî• –°—Ç–≤–æ—Ä–∏ –ë–ê–ñ–ê–ù–ù–Ø –∫—É–ø–∏—Ç–∏ - –æ–ø–∏—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏, —è–∫—ñ –æ—Ç—Ä–∏–º–∞—î –∫–ª—ñ—î–Ω—Ç
            5. üí∞ –ó–≥–∞–¥–∞–π –¶–Ü–ù–£ —Ç–∞ –ø—ñ–¥–∫—Ä–µ—Å–ª–∏ —â–æ —Ü–µ —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è –≤ –∑–¥–æ—Ä–æ–≤'—è
            6. üì¶ –Ø–∫—â–æ —î –∫—ñ–ª—å–∫–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ - –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π –Ω–∞–π–∫—Ä–∞—â–∏–π –¥–ª—è –ø–æ—Ç—Ä–µ–± –∫–ª—ñ—î–Ω—Ç–∞
            
            –°–¢–ò–õ–¨:
            - –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –Ω–∞ –º–æ–≤—ñ –∑–∞–ø–∏—Ç—É (–£–ö–†/–†–£–°/ENG)
            - –ë—É–¥—å –¥—Ä—É–∂–Ω—ñ–º, –∞–ª–µ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–º
            - –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π Markdown (**–∂–∏—Ä–Ω–∏–π**, # –∑–∞–≥–æ–ª–æ–≤–∫–∏)
            - –ü–∏—à–∏ 4-6 —Ä–µ—á–µ–Ω—å (–Ω–µ –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–æ!)
            - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –µ–º–æ–¥–∑—ñ –¥–ª—è –µ–º–æ—Ü—ñ–π–Ω–æ—Å—Ç—ñ (1-2 –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å)
            
            –Ø–ö–©–û –¢–û–í–ê–†–Ü–í –ù–ï–ú–ê–Ñ:
            - –í–∏–±–∞—á —Ç–∞ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π —Å—Ö–æ–∂—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (–≥—Ä–∏–±–∏, —Ç—Ä–∞–≤–∏, CBD, –º—ñ–∫—Ä–æ–¥–æ–∑–∏–Ω–≥)
            - –ó–∞–ø–∏—Ç–∞–π —â–æ —Å–∞–º–µ —Ü—ñ–∫–∞–≤–∏—Ç—å –∫–ª—ñ—î–Ω—Ç–∞
            
            –ü–†–ò–ö–õ–ê–î –•–û–†–û–®–û–á –í–Ü–î–ü–û–í–Ü–î–Ü:
            "–î–ª—è —ñ–º—É–Ω—ñ—Ç–µ—Ç—É —á—É–¥–æ–≤–æ –ø—ñ–¥—ñ–π–¥–µ –ß–∞–≥–∞! üçÑ –¶–µ –æ–¥–∏–Ω –∑ –Ω–∞–π–ø–æ—Ç—É–∂–Ω—ñ—à–∏—Ö –ø—Ä–∏—Ä–æ–¥–Ω–∏—Ö –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ñ–≤, –∑—ñ–±—Ä–∞–Ω–∏–π –≤ –µ–∫–æ–ª–æ–≥—ñ—á–Ω–æ —á–∏—Å—Ç–∏—Ö –∫–∞—Ä–ø–∞—Ç—Å—å–∫–∏—Ö –ª—ñ—Å–∞—Ö. –ß–∞–≥–∞ –∑–º—ñ—Ü–Ω—é—î —ñ–º—É–Ω—ñ—Ç–µ—Ç, –æ—á–∏—â—É—î –æ—Ä–≥–∞–Ω—ñ–∑–º —Ç–∞ –¥–∞—î –µ–Ω–µ—Ä–≥—ñ—é –±–µ–∑ —Å—Ç–∏–º—É–ª—è—Ç–æ—Ä—ñ–≤. –¶—ñ–Ω–∞ 350 –≥—Ä–Ω –∑–∞ 100–≥ - —Ü–µ 2-3 –º—ñ—Å—è—Ü—ñ —â–æ–¥–µ–Ω–Ω–æ–≥–æ –≤–∂–∏–≤–∞–Ω–Ω—è. –†–µ–∫–æ–º–µ–Ω–¥—É—é —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏!"
            """
            
            history = [{"role": "system", "content": system_prompt}]
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            for msg in request.messages[-3:]:
                role = "user" if msg.role == "user" else "assistant"
                history.append({"role": role, "content": msg.content})
                
            completion = await openai_client.chat.completions.create(
                model="gpt-4o-mini",
                messages=history,
                temperature=0.8,
                max_tokens=500
            )
            response_text = completion.choices[0].message.content
        else:
            # Fallback (–µ—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–∞ API)
            if found_products:
                response_text = "–û—Å—å —â–æ —è –∑–Ω–∞–π—à–æ–≤ –∑–∞ –≤–∞—à–∏–º –∑–∞–ø–∏—Ç–æ–º. –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Ü—ñ —Ç–æ–≤–∞—Ä–∏:"
            else:
                response_text = "–í–∏–±–∞—á—Ç–µ, —è –Ω–µ –∑–Ω–∞–π—à–æ–≤ —Ç–æ–≤–∞—Ä—ñ–≤ –∑–∞ –≤–∞—à–∏–º –∑–∞–ø–∏—Ç–æ–º. –°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –ø–æ—à—É–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ '–á–∂–æ–≤–∏–∫' –∞–±–æ '–ö–æ—Ä–¥–∏—Ü–µ–ø—Å')."

        # 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –∏ –∫–∞—Ä—Ç–æ—á–∫–∏
        return {
            "text": response_text,
            "products": found_products 
        }
            
    except Exception as e:
        print(f"Error in chat endpoint: {e}")
        return {
            "text": "–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.",
            "products": []
        }

'''

# –ó–±–∏—Ä–∞—î–º–æ –Ω–æ–≤–∏–π —Ñ–∞–π–ª
new_content = before_chat + new_chat_function + after_chat

# –ó–∞–ø–∏—Å—É—î–º–æ
with open('main.py', 'w', encoding='utf-8') as f:
    f.write(new_content)

print("‚úÖ AI —á–∞—Ç —É—Å–ø—ñ—à–Ω–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ!")
print("–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è:")
print("  - –ù–æ–≤–∏–π –ø—Ä–æ–¥–∞—é—á–∏–π —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç")
print("  - –ü–æ—à—É–∫ –ø–æ description, composition, usage")
print("  - –ó–±—ñ–ª—å—à–µ–Ω–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –¥–æ 8")
print("  - –ü—ñ–¥–≤–∏—â–µ–Ω–æ temperature –¥–æ 0.8")
print("  - –î–æ–¥–∞–Ω–æ max_tokens=500")
